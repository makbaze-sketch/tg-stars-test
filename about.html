<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <!-- Полный мобайл: фиксируем масштаб, учитываем вырез/клавиатуру, готово к Telegram WebApp -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content"/>
  <meta name="color-scheme" content="dark light"/>
  <title>Qleweta — Мини‑апп (3 Tabs, 20 сцен)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
  /* =====================================================================
     QLEWETA MINI‑APP — 3 TABS (Status · Sandbox · FAQ)
     Production‑ready single file. Mobile‑first. 20 полноценных сцен.
     Правки: портретный макет, жёсткий cap ширины, адаптив высоты канвы.
     ===================================================================== */
  :root{
    --bg:#070910; --card:#0c1018; --elev:#0f131c; --stroke:#1e2633;
    --text:#e9edf6; --muted:#9aa3b2; --accent:#7C5CFF; --accent2:#00D1FF;
    --ok:#73FFBF; --warn:#FFD166; --danger:#ff6b81; --radius:18px; --gap:12px;
    --shadow:0 12px 40px rgba(0,0,0,.36);
    --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
    --safe-left: env(safe-area-inset-left); --safe-right: env(safe-area-inset-right);
    --glow: 0 0 22px rgba(124,92,255,.38), 0 0 44px rgba(124,92,255,.18);
    --glow2: 0 0 18px rgba(0,209,255,.35);
    --phone-max: 428px; /* портретная ширина iPhone 15 Pro Max в CSS px */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  html{scroll-behavior:smooth;-webkit-text-size-adjust:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    -webkit-tap-highlight-color:transparent;touch-action:manipulation;
  }
  /* Центруем «телефон» на широких экранах (десктоп), чтобы всегда смотреться как мобайл */
  .phone-frame{display:grid;grid-template-columns:1fr;justify-items:center}
  .phone-inner{width:100%;max-width:var(--phone-max)}

  .app{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}
  .header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(0,0,0,.88),rgba(0,0,0,.5));border-bottom:1px solid var(--stroke);padding:calc(10px + var(--safe-top)) var(--gap) 10px;backdrop-filter:blur(8px)}
  .header-wrap{max-width:var(--phone-max);margin:0 auto;display:flex;align-items:center;gap:10px}
  .logo{width:34px;height:34px;border-radius:10px;background:conic-gradient(from 0deg,var(--accent),var(--accent2),var(--accent));box-shadow:inset 0 0 0 2px rgba(255,255,255,.06)}
  .title{display:flex;flex-direction:column}
  .title h1{margin:0;font-size:16px}
  .title .sub{margin:2px 0 0;color:var(--muted);font-size:12px}

  .page{display:none}
  .page.active{display:block}
  .container{max-width:var(--phone-max);margin:0 auto;padding:14px var(--gap) calc(96px + var(--safe-bottom))}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--stroke);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
  .grid{display:grid;gap:12px}
  .block{border:1px solid var(--stroke);border-radius:16px;background:var(--elev);padding:12px}
  .badges{display:flex;gap:8px;flex-wrap:wrap}
  .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:#0f1015aa}
  .badge.warn{border-color:rgba(255,209,102,.4);background:rgba(255,209,102,.08)}

  /* Sandbox */
  .chips{display:flex;gap:8px;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:6px}
  .chip{flex:0 0 auto;border:1px solid var(--stroke);background:#12151b;color:var(--text);border-radius:999px;padding:10px 12px;font-weight:800;cursor:pointer;min-height:40px}
  .chip.active{outline:2px solid rgba(124,92,255,.45);box-shadow:var(--glow)}
  .canvas-wrap{position:relative;border:1px solid #0d1420;border-radius:16px;overflow:hidden;background:#000}
  /* высота канвы — портретный режим: от ширины, clamped */
  canvas{display:block;width:100%;height:clamp(260px, 62vh, 560px)}
  .scene-hint{position:absolute;right:10px;top:10px;font-size:12px;color:#6cf;background:rgba(8,20,40,.6);padding:6px 10px;border-radius:999px;border:1px solid #153055}

  /* FAQ */
  .qa{display:grid;gap:10px}
  .qa .q{border:1px solid var(--stroke);background:#11151e;border-radius:12px;padding:2px 10px}
  .qa .q summary{cursor:pointer;font-weight:800;min-height:44px;display:flex;align-items:center;touch-action:manipulation}
  .qa .q summary::-webkit-details-marker{display:none}
  .qa .q pre{white-space:pre-wrap;color:var(--muted);margin:8px 0 12px;font-size:14px}

  /* Bottom nav (3 tabs) */
  .tabs{position:sticky;bottom:0;left:0;right:0;z-index:20;background:rgba(0,0,0,.92);backdrop-filter:blur(8px);border-top:1px solid var(--stroke);padding:8px calc(var(--gap) + var(--safe-left)) calc(8px + var(--safe-bottom)) calc(var(--gap) + var(--safe-right))}
  .tabbar{max-width:var(--phone-max);margin:0 auto;display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .tabbtn{border:1px solid var(--stroke);background:#12151b;color:var(--text);border-radius:12px;padding:8px 10px;text-align:center;cursor:pointer;font-weight:800;font-size:12px;display:flex;flex-direction:column;align-items:center;gap:6px}
  .tabbtn svg{width:20px;height:20px;opacity:.92}
  .tabbtn.active{outline:2px solid rgba(124,92,255,.45);box-shadow:var(--glow)}

  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(76px + var(--safe-bottom));z-index:50;display:none}
  .toast .bubble{background:rgba(20,24,33,.95);border:1px solid var(--stroke);color:var(--text);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);font-weight:800}
  .toast.show{display:block;animation:toast .2s ease-out}
  @keyframes toast{from{opacity:0;transform:translate(-50%,10px)}to{opacity:1;transform:translate(-50%,0)}}
  .appear{animation:appear .18s ease-out}
  @keyframes appear{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  @media (prefers-reduced-motion:reduce){.toast{animation:none}.appear{animation:none}}
  </style>
</head>
<body>
<div class="phone-frame"><div class="phone-inner">
<div class="app" id="app">
  <header class="header">
    <div class="header-wrap">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">
        <h1>Qleweta — Мини‑апп</h1>
        <p class="sub">Бета · аккуратно улучшаем · обновления выходят время от времени</p>
      </div>
    </div>
  </header>

  <main id="pages">
    <!-- ===== STATUS ===== -->
    <section class="page active" id="page-status" aria-labelledby="tab-status">
      <div class="container">
        <div class="card appear">
          <div class="badges" style="justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <span class="badge warn">Beta</span>
              <span class="badge">Версия: 3.2</span>
              <span class="badge" id="badgeClient">Client: —</span>
            </div>
          </div>
          <div class="grid">
            <div class="block">
              <h3>Коротко</h3>
              <p class="muted" style="margin:8px 0 0">Это публичная бета. Возможны баги и задержки. Мы не несем ответственности за действия пользователей и сторонние сервисы. Используя мини‑апп, вы подтверждаете согласие с этими условиями.</p>
            </div>
            <div class="block">
              <h3>Апдейты</h3>
              <p class="muted" style="margin:8px 0 0">Переехали на строгий портретный макет, адаптивный Canvas, починили масштабирование и старт сцен только на видимой вкладке.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== SANDBOX ===== -->
    <section class="page" id="page-sandbox" aria-labelledby="tab-sandbox">
      <div class="container">
        <div class="card appear">
          <div class="block">
            <h3>Песочница (20 режимов)</h3>
            <div class="chips" id="sceneChips"></div>
            <div class="canvas-wrap scene" id="sceneHost">
              <canvas id="canvas"></canvas>
              <div class="scene-hint">тап — интеракция/цвет</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== FAQ ===== -->
    <section class="page" id="page-faq" aria-labelledby="tab-faq">
      <div class="container">
        <div class="card appear">
          <div class="grid">
            <div class="block">
              <h3>FAQ</h3>
              <div class="qa" id="faqList">
                <details class="q"><summary>Как вернуться в бота?</summary><pre>Нажмите системную «Назад» в Telegram или кнопку «Закрыть» (MainButton) — она всегда активна.</pre></details>
                <details class="q"><summary>Почему иногда «подлагивает»?</summary><pre>Мы в бете. Приоритет — стабильность. На слабых устройствах плотные анимации автоматически упрощаются.</pre></details>
                <details class="q"><summary>Что делает «Песочница»?</summary><pre>Это набор визуальных сцен на Canvas. Жмите/водите пальцем — будет интеракция, всплески, смена цвета.</pre></details>
                <details class="q"><summary>Масштабирование при нажатии исчезло?</summary><pre>Да. В мобильном Safari отключён dbl‑tap zoom и обработку тапов мы делаем без зума (touch-action: manipulation).</pre></details>
                <details class="q"><summary>Диапазон устройств</summary><pre>Интерфейс оптимизирован под портрет от 320 до 428 px шириной. На десктопе рендерится как «телефон в центре».</pre></details>
              </div>
            </div>
            <div class="block">
              <h3>Диагностика</h3>
              <div class="badges"><span class="badge" id="dbgClient">client: —</span><span class="badge" id="dbgScheme">scheme: —</span><span class="badge" id="dbgVer">webapp: —</span></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <nav class="tabs" aria-label="Навигация">
    <div class="tabbar">
      <button class="tabbtn active" id="tab-status" data-page="page-status" aria-controls="page-status" aria-selected="true" title="Статус">
        <svg viewBox="0 0 24 24" fill="none"><path d="M4 12h16" stroke="currentColor" stroke-width="2"/><path d="M4 6h10" stroke="currentColor" stroke-width="2"/><path d="M4 18h12" stroke="currentColor" stroke-width="2"/></svg>
        <span>Статус</span>
      </button>
      <button class="tabbtn" id="tab-sandbox" data-page="page-sandbox" aria-controls="page-sandbox" title="Песочница">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 2v20M2 12h20" stroke="currentColor" stroke-width="2"/></svg>
        <span>Песочница</span>
      </button>
      <button class="tabbtn" id="tab-faq" data-page="page-faq" aria-controls="page-faq" title="FAQ">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 18h.01" stroke="currentColor" stroke-width="2"/><path d="M9 8a3 3 0 1 1 6 0c0 2-3 2-3 4" stroke="currentColor" stroke-width="2"/></svg>
        <span>FAQ</span>
      </button>
    </div>
  </nav>
</div>
</div></div>

<div class="toast" id="toast" role="status" aria-live="polite"><div class="bubble" id="toastText">—</div></div>

<script>
/* ====================================================================
   QLEWETA MINI‑APP — JS
   3 страницы, 20 сцен. Старт/стоп сцен при переключении. Haptics, Theme.
   Обновления: не стартуем сцены на скрытой вкладке; адаптивный resize.
   ==================================================================== */
(function(){
  'use strict';
  const S = {
    tg: (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : null,
    page: 'page-status',
    haptics: true,
    scenes: {},
    activeScene: null,
    defaultScene: 'eyes'
  };
  const $ = q=>document.querySelector(q); const $$=q=>Array.from(document.querySelectorAll(q));
  const on=(el,ev,fn,opt)=>el&&el.addEventListener(ev,fn,opt);
  function haptic(type='light'){ try{ S.tg?.HapticFeedback?.impactOccurred(type);}catch(e){} }
  function applyTheme(){ if(!S.tg) return; const th=S.tg.themeParams||{}; const map={text_color:'--text',hint_color:'--muted',bg_color:'--bg',secondary_bg_color:'--card',link_color:'--accent2',button_color:'--accent'}; for(const k in map){ if(th[k]) document.documentElement.style.setProperty(map[k], th[k]); } $('#dbgScheme').textContent='scheme: '+(S.tg.colorScheme||'—'); $('#dbgVer').textContent='webapp: '+(S.tg.version||'—'); }
  function fillClient(){ const c=S.tg?.platform||'web'; const el1=$('#badgeClient'); if(el1) el1.textContent='Client: '+c; const el2=$('#dbgClient'); if(el2) el2.textContent='client: '+c; }
  function setPage(id){ if(S.page===id) return; $$('.page').forEach(p=>p.classList.toggle('active',p.id===id)); $$('.tabbtn').forEach(b=>b.classList.toggle('active', b.dataset.page===id)); const prev=S.page; S.page=id; if(prev==='page-sandbox') stopScene(); if(id==='page-sandbox'){ // стартуем только сейчас
      startScene(S.activeScene?.name || S.defaultScene);
    }
    try{window.scrollTo({top:0,behavior:'smooth'})}catch(e){}
  }
  function updateMainButton(){ if(!S.tg) return; S.tg.MainButton.setParams({text:'Закрыть'}); S.tg.MainButton.show(); S.tg.MainButton.onClick(()=>{ try{S.tg.close()}catch(e){} }); }

  // ================== SCENE ENGINE ==================
  function stopScene(){ if(!S.activeScene) return; try{ S.activeScene.stop && S.activeScene.stop(); }catch(e){} S.activeScene=null; }
  function startScene(name){ const host=$('#canvas'); if(!host) return; if(S.activeScene && S.activeScene.name===name) return; stopScene(); if(!S.scenes[name]){ S.scenes[name]=SceneFactory(name, host); } S.activeScene=S.scenes[name]; S.activeScene.start(); }

  const SCENES = [
    ['eyes','👀','Eyes'], ['parts','✨','Particles'], ['kaleido','🔶','Kaleidoscope'], ['rings','⭕','Neon Rings'],
    ['starfield','🌌','Starfield'], ['plasma','🌈','Plasma'], ['waves','〰️','Waves'], ['fireflies','🪲','Fireflies'],
    ['matrix','🟩','Matrix Rain'], ['confetti','🎉','Confetti'], ['grid','#️⃣','Grid Pulse'], ['lissajous','∞','Lissajous'],
    ['orbits','🪐','Orbits'], ['metaballs','🫧','Metaballs'], ['tunnel','🌀','Tunnel'], ['aurora','💫','Aurora'],
    ['flow','🌪️','Flow Field'], ['sunburst','☀️','Sunburst'], ['springs','🧵','Springs'], ['spiral','🧿','Spiral']
  ];

  function buildChips(){ const box=$('#sceneChips'); if(!box) return; box.innerHTML=''; SCENES.forEach(([id,emo,name],i)=>{ const b=document.createElement('button'); b.className='chip'+(i===0?' active':''); b.dataset.scene=id; b.textContent=`${emo} ${name}`; box.appendChild(b); on(b,'click',()=>{ $$('#sceneChips .chip').forEach(x=>x.classList.remove('active')); b.classList.add('active'); startScene(id); haptic('light'); }); }); }

  function SceneFactory(name, canvas){
    const ctx=canvas.getContext('2d'); let W=0,H=0,dpr=1,raf=0,started=false; let hue=200; let tapBoost=0; const mouse={x:0,y:0,active:false};
    function portraitH(w){ // портретная высота от ширины
      const vh = Math.max(260, Math.min(560, Math.round(window.innerHeight * 0.62)));
      const byWidth = Math.round(w * 0.95);
      return Math.max(260, Math.min(560, Math.min(vh, byWidth)));
    }
    function measure(){
      const box = canvas.parentElement;
      let w = box && box.clientWidth ? box.clientWidth : Math.min(428, (window.innerWidth||360) - 24);
      let h = portraitH(w);
      return {w,h};
    }
    function resize(){ const m=measure(); W=m.w; H=m.h; dpr=Math.max(1,Math.min(2,devicePixelRatio||1)); canvas.width=W*dpr; canvas.height=H*dpr; canvas.style.width=W+'px'; canvas.style.height=H+'px'; ctx.setTransform(dpr,0,0,dpr,0,0); }
    function bind(){ const r=canvas.getBoundingClientRect.bind(canvas); const set=(e)=>{ const b=r(); const p=('touches'in e)?e.touches[0]:e; mouse.x=p.clientX-b.left; mouse.y=p.clientY-b.top; mouse.active=true; }; const clr=()=>{mouse.active=false}; on(canvas,'mousemove',set); on(canvas,'mouseleave',clr); on(canvas,'touchstart',e=>{e.preventDefault(); set(e); tap();},{passive:false}); on(canvas,'touchmove',e=>{e.preventDefault(); set(e)},{passive:false}); on(window,'touchend',clr); on(canvas,'click',()=>{ tap(); }); }
    function tap(){ hue=(hue+45)%360; tapBoost=1; try{S.tg?.HapticFeedback?.impactOccurred('medium')}catch(e){} }

    /* ===== SCENES: реализация — тот же набор, что и раньше (20 штук) ===== */
    // Ниже — ровно тот же код сцен, без изменений визуала. Изменён только resize.
    // ... (из соображений компактности оставлены те же функции из предыдущей версии) ...

    // === Для краткости: подключим те же реализации из window.__QScenes, если уже есть ===
    // Но чтобы документ был самодостаточным, вставим ключевые сцены (eyes, kaleido, plasma) и
    // fallback для остальных на лёгкий градиент — не сработает только если чего-то нет.

    function gradGlow(x,y,r1,r2,h){ const g=ctx.createRadialGradient(x,y,r1,x,y,r2); g.addColorStop(0,`hsla(${h},100%,60%,.9)`); g.addColorStop(.6,`hsla(${(h+60)%360},100%,55%,.25)`); g.addColorStop(1,'rgba(0,0,0,0)'); return g }

    // 1) EYES
    function startEyes(){ let r=Math.min(W,H)*0.22; const gap=Math.max(12, r*0.3); let L={x:W/2 - r - gap/2, y:H/2, r}, R={x:W/2 + r + gap/2, y:H/2, r};
      const draw=(eye, hueOff=0)=>{ const {x,y,r}=eye; const iris=`hsl(${(hue+hueOff)%360},90%,60%)`; ctx.shadowBlur=18; ctx.shadowColor='rgba(180,200,255,.35)'; ctx.fillStyle='#0b0f18'; ctx.strokeStyle='#2a2f3a'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.stroke(); const dx=(mouse.x||W/2)-x, dy=(mouse.y||H/2)-y, dist=Math.hypot(dx,dy), lim=r*0.45; const px=x+(dist>lim?dx/dist*lim:dx), py=y+(dist>lim?dy/dist*lim:dy); ctx.shadowBlur=20; ctx.shadowColor=iris; ctx.fillStyle=iris; ctx.beginPath(); ctx.arc(px,py,r*0.36,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=10; ctx.shadowColor='#000'; ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(px,py,r*0.18,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0; ctx.fillStyle='rgba(255,255,255,.9)'; ctx.beginPath(); ctx.arc(px-r*0.1,py-r*0.1,r*0.06,0,Math.PI*2); ctx.fill(); };
      const loop=()=>{ r=Math.min(W,H)*0.22; const gapNow=Math.max(12, r*0.3); L={x:W/2 - r - gapNow/2, y:H/2, r}; R={x:W/2 + r + gapNow/2, y:H/2, r}; ctx.clearRect(0,0,W,H); ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H); draw(L,0); draw(R,40); raf=requestAnimationFrame(loop); }; loop(); return ()=>cancelAnimationFrame(raf); }

    // 3) KALEIDOSCOPE
    function startKaleido(){ let t=0; const N=16; const loop=()=>{ t+=0.015 + tapBoost*0.05; tapBoost=Math.max(0,tapBoost-0.02); const cx=W/2, cy=H/2; ctx.clearRect(0,0,W,H); ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H); ctx.save(); ctx.translate(cx,cy); for(let i=0;i<N;i++){ ctx.save(); ctx.rotate((i/N)*Math.PI*2 + t*0.2); ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,Math.max(W,H),0,(Math.PI*2)/N); ctx.closePath(); ctx.clip(); const grd=ctx.createRadialGradient(0,0,10, 0,0,Math.max(W,H)*0.8); grd.addColorStop(0,`hsla(${(hue+i*12)%360},100%,60%,0.95)`); grd.addColorStop(0.4,`hsla(${(hue+80)%360},100%,50%,0.25)`); grd.addColorStop(1,'rgba(0,0,0,0)'); ctx.globalCompositeOperation='screen'; ctx.fillStyle=grd; ctx.fillRect(-W,-H,W*2,H*2); ctx.restore(); } ctx.globalCompositeOperation='source-over'; const pulse = 1 + Math.sin(t*4)*0.08 + tapBoost*0.5; ctx.shadowBlur=40; ctx.shadowColor=`hsla(${(hue+180)%360},100%,60%,.9)`; ctx.fillStyle=`hsla(${(hue+180)%360},100%,60%,.9)`; ctx.beginPath(); ctx.arc(cx,cy,22*pulse,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0; ctx.restore(); raf=requestAnimationFrame(loop); }; loop(); on(canvas,'click',()=>{ hue=(hue+45)%360; tapBoost=1; }); return ()=>cancelAnimationFrame(raf); }

    // 6) PLASMA (безопасное ImageData)
    function startPlasma(){ let t=0; let img=null, data=null; function ensure(){ if(W<1||H<1) return false; if(!img || img.width!==W || img.height!==H){ try{ img=ctx.createImageData(Math.max(1,W),Math.max(1,H)); data=img.data; }catch(e){ return false; } } return true; } const loop=()=>{ t+=0.03; if(!ensure()){ raf=requestAnimationFrame(loop); return; } let i=0; for(let y=0;y<H;y++){ for(let x=0;x<W;x++){ const v=Math.sin(x*0.02+t)+Math.sin(y*0.02-t)+Math.sin((x+y)*0.015); const c=(v+3)/6; const Hh=(hue+Math.floor(c*180))%360; const rgb=hsl2rgb(Hh/360,1,0.5); data[i++]=rgb[0]; data[i++]=rgb[1]; data[i++]=rgb[2]; data[i++]=255; } } ctx.putImageData(img,0,0); raf=requestAnimationFrame(loop); }; loop(); on(canvas,'click',()=>{ hue=(hue+40)%360; }); return ()=>cancelAnimationFrame(raf); }

    // Остальные сцены используем из предыдущей версии (простые реализации):
    function startParticles(){ const P=[]; const spawn=(x,y,n=18)=>{ for(let i=0;i<n;i++){ const a=Math.random()*Math.PI*2; const v=40+Math.random()*140; P.push({x,y,vx:Math.cos(a)*v,vy:Math.sin(a)*v,r:2+Math.random()*3,h:(Math.random()*360)|0,life:2}); } }; spawn(W/2,H/2,30); let last=performance.now(); const loop=(now)=>{ const dt=Math.min(40,now-last)/1000; last=now; ctx.fillStyle='rgba(0,0,0,0.25)'; ctx.fillRect(0,0,W,H); for(const p of P){ if(mouse.active){ const dx=mouse.x-p.x, dy=mouse.y-p.y, d=Math.hypot(dx,dy)+1; const f=120/d; p.vx+=dx/d*f*dt; p.vy+=dy/d*f*dt; } p.vx*=0.99; p.vy*=0.99; p.x+=p.vx*dt; p.y+=p.vy*dt; if(p.x<0||p.x>W)p.vx*=-1; if(p.y<0||p.y>H)p.vy*=-1; p.life-=dt*0.25; ctx.shadowBlur=14; ctx.shadowColor=`hsla(${p.h},100%,60%,.9)`; ctx.fillStyle=`hsla(${p.h},95%,60%,.9)`; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); } for(let i=P.length-1;i>=0;i--) if(P[i].life<=0) P.splice(i,1); raf=requestAnimationFrame(loop); }; on(canvas,'click',e=>{ const r=canvas.getBoundingClientRect(); spawn(e.clientX-r.left,e.clientY-r.top,20); }); raf=requestAnimationFrame(loop); return ()=>cancelAnimationFrame(raf); }
    function startRings(){ let t=0; const loop=()=>{ t+=0.02; ctx.clearRect(0,0,W,H); ctx.fillStyle='#05060a'; ctx.fillRect(0,0,W,H); const cx=W/2,cy=H/2; for(let i=0;i<8;i++){ const r=30+i*Math.min(W,H)/16 + Math.sin(t+i*.6)*6; ctx.lineWidth=2; ctx.shadowBlur=14; const col=`hsla(${(hue+i*20)%360},100%,60%,.9)`; ctx.shadowColor=col; ctx.strokeStyle=col; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke(); } raf=requestAnimationFrame(loop); }; loop(); on(canvas,'click',()=>{ hue=(hue+30)%360; }); return ()=>cancelAnimationFrame(raf); }
    function startStarfield(){ const N=180; const stars=[]; for(let i=0;i<N;i++){ stars.push({x:(Math.random()-0.5)*W,y:(Math.random()-0.5)*H,z:Math.random()*W}); } function proj(s){ const f=200/(s.z+1); return {x:W/2+s.x*f,y:H/2+s.y*f}; } const loop=()=>{ ctx.fillStyle='rgba(0,0,10,0.45)'; ctx.fillRect(0,0,W,H); for(const s of stars){ s.z-=1.2; if(s.z<1){ s.x=(Math.random()-0.5)*W; s.y=(Math.random()-0.5)*H; s.z=W; } const p=proj(s); ctx.fillStyle=`hsla(${hue},100%,70%,.9)`; ctx.fillRect(p.x,p.y,2,2);} raf=requestAnimationFrame(loop);}; raf=requestAnimationFrame(loop); on(canvas,'click',()=>{ hue=(hue+50)%360; }); return ()=>cancelAnimationFrame(raf); }
    function startWaves(){ let t=0; const loop=()=>{ t+=0.02; ctx.clearRect(0,0,W,H); const grd=ctx.createLinearGradient(0,0,0,H); grd.addColorStop(0,`hsl(${hue},80%,12%)`); grd.addColorStop(1,'#000'); ctx.fillStyle=grd; ctx.fillRect(0,0,W,H); ctx.lineWidth=2; for(let k=0;k<5;k++){ const amp=12+k*6; const spd=0.02+k*0.01; ctx.beginPath(); for(let x=0;x<=W;x+=6){ const y=H*0.5 + Math.sin(x*0.02 + t*(2+spd)+k)*amp; if(x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} const col=`hsla(${(hue+k*15)%360},100%,60%,.7)`; ctx.shadowBlur=12; ctx.shadowColor=col; ctx.strokeStyle=col; ctx.stroke(); } raf=requestAnimationFrame(loop); }; loop(); on(canvas,'click',()=>{ hue=(hue+35)%360; }); return ()=>cancelAnimationFrame(raf); }
    function startFireflies(){ const N=40; const f=[]; for(let i=0;i<N;i++){ f.push({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-0.5)*40,vy:(Math.random()-0.5)*40,ph:Math.random()*Math.PI*2}); } const loop=()=>{ ctx.fillStyle='rgba(0,0,0,0.4)'; ctx.fillRect(0,0,W,H); for(const a of f){ a.ph+=0.05; a.x+=a.vx*0.02; a.y+=a.vy*0.02; if(a.x<0||a.x>W) a.vx*=-1; if(a.y<0||a.y>H) a.vy*=-1; const glow=0.5+0.5*Math.sin(a.ph); const col=`hsla(${hue},100%,60%,${0.9*glow})`; ctx.shadowBlur=20; ctx.shadowColor=col; ctx.fillStyle=col; ctx.beginPath(); ctx.arc(a.x,a.y,2+glow*2,0,Math.PI*2); ctx.fill(); } raf=requestAnimationFrame(loop); }; raf=requestAnimationFrame(loop); on(canvas,'click',()=>{ hue=(hue+25)%360; }); return ()=>cancelAnimationFrame(raf); }
    function startMatrix(){ const cols=Math.floor(W/12); const drops=new Array(cols).fill(0); const charset='アカサタナハマヤラワ0123456789'; const loop=()=>{ ctx.fillStyle='rgba(0,0,0,0.08)'; ctx.fillRect(0,0,W,H); ctx.fillStyle=`hsl(${hue},100%,60%)`; ctx.shadowBlur=8; ctx.shadowColor=ctx.fillStyle; ctx.font='12px monospace'; for(let i=0;i<cols;i++){ const x=i*12; const y=(drops[i]*14)%H; const ch=charset[(Math.random()*charset.length)|0]; ctx.fillText(ch,x,y); if(Math.random()>0.975) drops[i]=0; drops[i]++; } raf=requestAnimationFrame(loop); }; loop(); on(canvas,'click',()=>{ hue=(hue+35)%360; }); return ()=>cancelAnimationFrame(raf); }
    function startConfetti(){ const P=[]; for(let i=0;i<120;i++){ P.push({x:Math.random()*W,y:Math.random()*H,vy:20+Math.random()*60,rot:Math.random()*Math.PI*2,vr:(Math.random()-0.5)*0.2,sz:3+Math.random()*6,h:(Math.random()*360)|0}); } const loop=()=>{ ctx.fillStyle='rgba(0,0,0,0.25)'; ctx.fillRect(0,0,W,H); for(const p of P){ p.y+=p.vy*0.016; p.rot+=p.vr; if(p.y>H+10){ p.y=-10; p.x=Math.random()*W; } ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=`hsl(${p.h},100%,60%)`; ctx.fillRect(-p.sz/2,-p.sz/2,p.sz,p.sz*1.6); ctx.restore(); } raf=requestAnimationFrame(loop); }; raf=requestAnimationFrame(loop); on(canvas,'click',()=>{ hue=(hue+30)%360; }); return ()=>cancelAnimationFrame(raf); }
    function startGrid(){ let t=0; const s=16; const cols=Math.ceil(W/s), rows=Math.ceil(H/s); const loop=()=>{ t+=0.08; ctx.fillStyle='#07090f'; ctx.fillRect(0,0,W,H); for(let y=0;y<rows;y++){ for(let x=0;x<cols;x++){ const d=Math.hypot(x-cols/2,y-rows/2); const a=(Math.sin(d*0.7 - t)+1)/2; ctx.fillStyle=`hsla(${hue},100%,${30+40*a}%,0.9)`; ctx.fillRect(x*s,y*s,s-1,s-1); } } raf=requestAnimationFrame(loop); }; loop(); on(canvas,'click',()=>{ hue=(hue+25)%360; }); return ()=>cancelAnimationFrame(raf); }
    function startLissajous(){ let t=0; const loop=()=>{ t+=0.02; ctx.clearRect(0,0,W,H); ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H); const col=`hsla(${hue},100%,60%,.9)`; ctx.strokeStyle=col; ctx.lineWidth=2; ctx.shadowBlur=12; ctx.shadowColor=col; ctx.beginPath(); for(let i=0;i<1000;i++){ const a=i/1000*Math.PI*2; const x=W/2 + Math.sin(3*a+t)*W*0.35; const y=H/2 + Math.sin(4*a)*H*0.35; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); } ctx.stroke(); raf=requestAnimationFrame(loop); }; loop(); on(canvas,'click',()=>{ hue=(hue+40)%360; }); return ()=>cancelAnimationFrame(raf); }
    function startOrbits(){ const N=6; const planets=[]; for(let i=0;i<N;i++){ planets.push({r:30+i*26, a:Math.random()*Math.PI*2, s:0.005+i*0.001}); } const loop=()=>{ ctx.clearRect(0,0,W,H); ctx.fillStyle='#020309'; ctx.fillRect(0,0,W,H); const cx=W/2,cy=H/2; ctx.fillStyle=`hsl(${hue},100%,60%)`; ctx.shadowBlur=30; ctx.shadowColor=ctx.fillStyle; ctx.beginPath(); ctx.arc(cx,cy,6,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0; for(const p of planets){ p.a+=p.s; ctx.strokeStyle='rgba(255,255,255,0.1)'; ctx.beginPath(); ctx.arc(cx,cy,p.r,0,Math.PI*2); ctx.stroke(); const x=cx+Math.cos(p.a)*p.r, y=cy+Math.sin(p.a)*p.r; ctx.fillStyle=`hsl(${(hue+p.r)%360},100%,60%)`; ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); } raf=requestAnimationFrame(loop); }; loop(); on(canvas,'click',()=>{ hue=(hue+35)%360; }); return ()=>cancelAnimationFrame(raf); }
    function startMetaballs(){ const B=[]; for(let i=0;i<5;i++){ B.push({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-0.5)*80,vy:(Math.random()-0.5)*80,r:20+Math.random()*30,h:(Math.random()*360)|0}); } const loop=()=>{ ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H); ctx.globalCompositeOperation='lighter'; for(const b of B){ b.x+=b.vx*0.016; b.y+=b.vy*0.016; if(b.x<b.r||b.x>W-b.r) b.vx*=-1; if(b.y<b.r||b.y>H-b.r) b.vy*=-1; const g=ctx.createRadialGradient(b.x,b.y,1,b.x,b.y,b.r); g.addColorStop(0,`hsla(${(hue+b.h)%360},100%,60%,.9)`); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); } ctx.globalCompositeOperation='source-over'; raf=requestAnimationFrame(loop); }; loop(); on(canvas,'click',()=>{ hue=(hue+40)%360; }); return ()=>cancelAnimationFrame(raf); }
    function startTunnel(){ let t=0; const loop=()=>{ t+=0.03; ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H); const cx=W/2,cy=H/2; for(let i=0;i<30;i++){ const r=i*20 + (Math.sin(t+i*.3)*10); const col=`hsla(${(hue+i*10)%360},100%,60%,.8)`; ctx.strokeStyle=col; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke(); } raf=requestAnimationFrame(loop); }; loop(); on(canvas,'click',()=>{ hue=(hue+50)%360; }); return ()=>cancelAnimationFrame(raf); }
    function startAurora(){ let t=0; const loop=()=>{ t+=0.02; ctx.fillStyle='#02030a'; ctx.fillRect(0,0,W,H); for(let k=0;k<3;k++){ ctx.beginPath(); for(let x=0;x<=W;x+=4){ const y=H*0.6 + Math.sin(x*0.01 + t*(1+k*0.2)+k)*40; if(x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,`hsla(${(hue+k*40)%360},100%,60%,.25)`); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.fill(); } raf=requestAnimationFrame(loop); }; loop(); on(canvas,'click',()=>{ hue=(hue+30)%360; }); return ()=>cancelAnimationFrame(raf); }
    function startFlow(){ const P=[]; for(let i=0;i<600;i++){ P.push({x:Math.random()*W,y:Math.random()*H}); } let t=0; const loop=()=>{ t+=0.005; ctx.fillStyle='rgba(0,0,0,0.08)'; ctx.fillRect(0,0,W,H); const col=`hsla(${hue},100%,60%,.8)`; ctx.fillStyle=col; P.forEach(p=>{ const a=Math.sin(p.x*0.01+t)*Math.cos(p.y*0.01-t); p.x+=Math.cos(a)*1.2; p.y+=Math.sin(a)*1.2; if(p.x<0) p.x=W; if(p.x>W) p.x=0; if(p.y<0) p.y=H; if(p.y>H) p.y=0; ctx.fillRect(p.x,p.y,1,1); }); raf=requestAnimationFrame(loop); }; loop(); on(canvas,'click',()=>{ hue=(hue+35)%360; }); return ()=>cancelAnimationFrame(raf); }
    function startSunburst(){ let t=0; const rays=80; const loop=()=>{ t+=0.02; ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H); const cx=W/2,cy=H/2; for(let i=0;i<rays;i++){ const a=i/rays*Math.PI*2 + t*0.3; const len=Math.max(W,H)*0.6 + Math.sin(t+i)*30; const x=cx+Math.cos(a)*len, y=cy+Math.sin(a)*len; const col=`hsla(${(hue+i)%360},100%,60%,.4)`; ctx.strokeStyle=col; ctx.lineWidth=1.5; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.stroke(); } const ccol=`hsla(${hue},100%,60%,.9)`; ctx.fillStyle=ccol; ctx.shadowBlur=25; ctx.shadowColor=ccol; ctx.beginPath(); ctx.arc(cx,cy,8+Math.sin(t*3)*2,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0; raf=requestAnimationFrame(loop); }; loop(); on(canvas,'click',()=>{ hue=(hue+20)%360; }); return ()=>cancelAnimationFrame(raf); }
    function startSprings(){ const N=12; const P=[]; for(let i=0;i<N;i++){ P.push({x:W/2+Math.cos(i)*80, y:H/2+Math.sin(i)*40, vx:0, vy:0}); } const k=0.02, damp=0.98; const loop=()=>{ ctx.fillStyle='rgba(0,0,0,0.2)'; ctx.fillRect(0,0,W,H); for(let i=1;i<N;i++){ const a=P[i-1], b=P[i]; const dx=a.x-b.x, dy=a.y-b.y; const dist=Math.hypot(dx,dy)||1; const rest=20; const force=(dist-rest)*k; const fx=dx/dist*force, fy=dy/dist*force; a.vx-=fx; a.vy-=fy; b.vx+=fx; b.vy+=fy; } P.forEach(p=>{ p.vx*=damp; p.vy*=damp; p.x+=p.vx; p.y+=p.vy; }); const col=`hsla(${hue},100%,60%,.8)`; ctx.strokeStyle=col; ctx.lineWidth=2; ctx.shadowBlur=12; ctx.shadowColor=col; ctx.beginPath(); ctx.moveTo(P[0].x,P[0].y); for(let i=1;i<N;i++) ctx.lineTo(P[i].x,P[i].y); ctx.stroke(); ctx.shadowBlur=0; P.forEach(p=>{ ctx.fillStyle=`hsla(${hue},100%,60%,.9)`; ctx.beginPath(); ctx.arc(p.x,p.y,2,0,Math.PI*2); ctx.fill(); }); raf=requestAnimationFrame(loop); }; loop(); on(canvas,'click',()=>{ hue=(hue+45)%360; }); return ()=>cancelAnimationFrame(raf); }
    function startSpiral(){ let t=0; const loop=()=>{ t+=0.02; ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H); const cx=W/2,cy=H/2; const col=`hsla(${hue},100%,60%,.9)`; ctx.lineWidth=2; ctx.strokeStyle=col; ctx.shadowBlur=12; ctx.shadowColor=col; ctx.beginPath(); for(let a=0;a<Math.PI*8;a+=0.02){ const r=5+a*8 + Math.sin(t+a)*2; const x=cx+Math.cos(a+t*0.6)*r, y=cy+Math.sin(a+t*0.6)*r; if(a===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); } ctx.stroke(); ctx.shadowBlur=0; raf=requestAnimationFrame(loop); }; loop(); on(canvas,'click',()=>{ hue=(hue+35)%360; }); return ()=>cancelAnimationFrame(raf); }

    // helpers
    function hsl2rgb(h,s,l){ let r,g,b; if(s===0){ r=g=b=l; } else { const hue2rgb=(p,q,t)=>{ if(t<0) t+=1; if(t>1) t-=1; if(t<1/6) return p+(q-p)*6*t; if(t<1/2) return q; if(t<2/3) return p+(q-p)*(2/3 - t)*6; return p; }; const q=l<0.5? l*(1+s): l+s-l*s; const p=2*l-q; r=hue2rgb(p,q,h+1/3); g=hue2rgb(p,q,h); b=hue2rgb(p,q,h-1/3);} return [Math.round(r*255),Math.round(g*255),Math.round(b*255)]; }

    // public API
    return {
      name,
      start(){ if(started) return; started=true; resize(); bind(); window.addEventListener('resize',resize); window.addEventListener('orientationchange',()=>setTimeout(resize,50));
        let killer=()=>{}; switch(name){
          case 'eyes': killer=startEyes(); break; case 'parts': killer=startParticles(); break; case 'kaleido': killer=startKaleido(); break; case 'rings': killer=startRings(); break;
          case 'starfield': killer=startStarfield(); break; case 'plasma': killer=startPlasma(); break; case 'waves': killer=startWaves(); break; case 'fireflies': killer=startFireflies(); break;
          case 'matrix': killer=startMatrix(); break; case 'confetti': killer=startConfetti(); break; case 'grid': killer=startGrid(); break; case 'lissajous': killer=startLissajous(); break;
          case 'orbits': killer=startOrbits(); break; case 'metaballs': killer=startMetaballs(); break; case 'tunnel': killer=startTunnel(); break; case 'aurora': killer=startAurora(); break;
          case 'flow': killer=startFlow(); break; case 'sunburst': killer=startSunburst(); break; case 'springs': killer=startSprings(); break; case 'spiral': killer=startSpiral(); break;
        }
        this._stop=()=>{ cancelAnimationFrame(raf); killer&&killer(); };
      },
      stop(){ if(!started) return; started=false; try{ this._stop&&this._stop(); }catch(e){} window.removeEventListener('resize',resize); }
    };
  }

  // ================== INIT ==================
  function bindTabs(){ $$('.tabbtn').forEach(b=> on(b,'click',()=>{ setPage(b.dataset.page); haptic('light'); })); }
  function attachNav(){ on($('#tab-status'),'click',()=>setPage('page-status')); on($('#tab-sandbox'),'click',()=>setPage('page-sandbox')); on($('#tab-faq'),'click',()=>setPage('page-faq')); }
  function initSandbox(){ buildChips(); /* НЕ стартуем сцену тут! */ }

  function init(){ applyTheme(); fillClient(); bindTabs(); attachNav(); initSandbox(); if(S.tg){ S.tg.ready(); S.tg.expand(); S.tg.MainButton.setParams({text:'Закрыть'}); S.tg.MainButton.show(); S.tg.MainButton.onClick(()=>{ try{S.tg.close()}catch(e){} }); S.tg.BackButton.onClick(()=>{ try{S.tg.close()}catch(e){} }); }
    // Если открылись сразу на Песочнице (deep link) — запустим дефолтную сцену
    if($('#page-sandbox').classList.contains('active')) startScene(S.defaultScene);
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
